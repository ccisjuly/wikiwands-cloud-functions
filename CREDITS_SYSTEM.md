# ç‚¹æ•°ç³»ç»Ÿè¯´æ˜

## æ¦‚è¿°

ç‚¹æ•°ç³»ç»ŸåŒ…å«ä¸¤ç§ç±»å‹çš„ç‚¹æ•°ï¼š
- **gift_creditï¼ˆèµ é€ç‚¹æ•°ï¼‰**ï¼šæ¯æœˆé‡ç½®ä¸º 10 ç‚¹ï¼ˆå½“æƒç›Šæ¿€æ´»æ—¶ï¼‰
- **paid_creditï¼ˆä»˜è´¹ç‚¹æ•°ï¼‰**ï¼šéè®¢é˜…è´­ä¹°æ—¶å¢åŠ  10 ç‚¹

## åŠŸèƒ½è¯´æ˜

### 1. éè®¢é˜…è´­ä¹°ç›‘å¬ (`onNonSubscriptionPurchase`)

**ç›‘å¬ä½ç½®**ï¼š`payments/rc` é›†åˆçš„åˆ›å»ºäº‹ä»¶

**è§¦å‘æ¡ä»¶**ï¼šRevenueCat Firebase Extension å†™å…¥è´­ä¹°äº‹ä»¶åˆ° Firestore

**å¤„ç†é€»è¾‘**ï¼š
- æ£€æµ‹åˆ°éè®¢é˜…è´­ä¹°äº‹ä»¶æ—¶ï¼Œè‡ªåŠ¨å¢åŠ ç”¨æˆ·çš„ `paid_credit` 10 ç‚¹
- æ”¯æŒå¤šç§äº‹ä»¶ç±»å‹è¯†åˆ«ï¼š
  - `NON_RENEWING_PURCHASE`
  - `PRODUCT_PURCHASED`
  - `INITIAL_PURCHASE`ï¼ˆä¸”äº§å“ä¸æ˜¯è®¢é˜…ç±»å‹ï¼‰

**å­—æ®µå…¼å®¹æ€§**ï¼š
- æ”¯æŒå¤šç§å­—æ®µåæ ¼å¼ï¼ˆå…¼å®¹ä¸åŒçš„æ•°æ®æ ¼å¼ï¼‰ï¼š
  - `event` / `type` / `event_type` / `eventType`
  - `uid` / `app_user_id` / `appUserID` / `appUserId`
  - `product_id` / `productId` / `product_identifier` / `productIdentifier`

### 2. æƒç›Šæ¿€æ´»ç›‘å¬ (`onEntitlementActivated`)

**ç›‘å¬ä½ç½®**ï¼š`entitlements` é›†åˆçš„æ›´æ–°äº‹ä»¶

**è§¦å‘æ¡ä»¶**ï¼šæƒç›Šä»éæ¿€æ´»çŠ¶æ€å˜ä¸ºæ¿€æ´»çŠ¶æ€

**å¤„ç†é€»è¾‘**ï¼š
- æ£€æµ‹åˆ°æƒç›Šæ¿€æ´»æ—¶ï¼Œè‡ªåŠ¨é‡ç½®ç”¨æˆ·çš„ `gift_credit` ä¸º 10 ç‚¹

### 3. æ¯æœˆå®šæ—¶é‡ç½® (`refreshMonthlyCredits`)

**è¿è¡Œæ—¶é—´**ï¼šæ¯æœˆ 1 å· 00:00 UTC

**å¤„ç†é€»è¾‘**ï¼š
- æ‰«ææ‰€æœ‰æœ‰æ¿€æ´»æƒç›Šçš„ç”¨æˆ·
- é‡ç½®è¿™äº›ç”¨æˆ·çš„ `gift_credit` ä¸º 10 ç‚¹

### 4. ç‚¹æ•°ä½¿ç”¨ (`useCredits`)

**è§„åˆ™**ï¼šå…ˆç”¨ `gift_credit`ï¼Œå†ç”¨ `paid_credit`

**å¹¶å‘å®‰å…¨**ï¼šä½¿ç”¨ Firestore Transaction é˜²æ­¢åŒå†™

### 5. é€€æ¬¾å¤„ç† (`refundCredits`)

**è§„åˆ™**ï¼šåªä» `paid_credit` ä¸­æ‰£é™¤

**å¹¶å‘å®‰å…¨**ï¼šä½¿ç”¨ Firestore Transaction é˜²æ­¢å¹¶å‘é—®é¢˜

## éªŒè¯ç›‘å¬å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œ

### æ–¹æ³• 1ï¼šæŸ¥çœ‹ Firebase Functions æ—¥å¿—

1. æ‰“å¼€ Firebase Console
2. è¿›å…¥ Functions é¡µé¢
3. æŸ¥çœ‹ `onNonSubscriptionPurchase` å‡½æ•°çš„æ—¥å¿—
4. å½“æœ‰è´­ä¹°äº‹ä»¶æ—¶ï¼Œåº”è¯¥çœ‹åˆ°ç±»ä¼¼æ—¥å¿—ï¼š
   ```
   ğŸ“¦ æ”¶åˆ° RevenueCat äº‹ä»¶: <eventId>
   ğŸ“‹ è§£æäº‹ä»¶: eventType=..., uid=..., productId=...
   âœ… æ£€æµ‹åˆ°éè®¢é˜…è´­ä¹°äº‹ä»¶: ..., ä¸ºç”¨æˆ· ... å¢åŠ  10 ç‚¹ paid_credit
   ```

### æ–¹æ³• 2ï¼šæ£€æŸ¥ Firestore æ•°æ®

1. æ‰“å¼€ Firestore Console
2. æŸ¥çœ‹ `payments/rc` é›†åˆï¼Œç¡®è®¤æœ‰æ–°çš„è´­ä¹°äº‹ä»¶æ–‡æ¡£
3. æŸ¥çœ‹ `credits/{uid}` æ–‡æ¡£ï¼Œç¡®è®¤ `paid_credit` æ˜¯å¦å¢åŠ 

### æ–¹æ³• 3ï¼šæµ‹è¯•è´­ä¹°

1. åœ¨åº”ç”¨ä¸­è´­ä¹°ä¸€ä¸ªéè®¢é˜…äº§å“
2. ç­‰å¾…å‡ ç§’é’Ÿ
3. æ£€æŸ¥ `credits/{uid}` æ–‡æ¡£ä¸­çš„ `paid_credit` æ˜¯å¦å¢åŠ äº† 10 ç‚¹

## è°ƒè¯•æŠ€å·§

### å¦‚æœç›‘å¬å™¨æ²¡æœ‰è§¦å‘

1. **æ£€æŸ¥ Firestore è§„åˆ™**ï¼š
   - ç¡®ä¿ `payments/rc` é›†åˆå…è®¸ Extension å†™å…¥
   - Extension ä½¿ç”¨ Admin SDKï¼Œä¸å—è§„åˆ™é™åˆ¶ï¼Œä½†å¯ä»¥æ£€æŸ¥è§„åˆ™æ˜¯å¦æ­£ç¡®

2. **æ£€æŸ¥ Extension é…ç½®**ï¼š
   - ç¡®è®¤ RevenueCat Firebase Extension å·²æ­£ç¡®å®‰è£…
   - ç¡®è®¤ Extension é…ç½®äº†æ­£ç¡®çš„ RevenueCat API Key
   - ç¡®è®¤ Extension æŒ‡å‘æ­£ç¡®çš„ Firestore é›†åˆè·¯å¾„

3. **æŸ¥çœ‹ Extension æ—¥å¿—**ï¼š
   - åœ¨ Firebase Console ä¸­æŸ¥çœ‹ Extension çš„æ‰§è¡Œæ—¥å¿—
   - ç¡®è®¤ Extension æ˜¯å¦æˆåŠŸæ¥æ”¶åˆ° RevenueCat webhook

4. **æ£€æŸ¥å‡½æ•°éƒ¨ç½²**ï¼š
   ```bash
   firebase functions:list
   ```
   - ç¡®è®¤ `onNonSubscriptionPurchase` å‡½æ•°å·²éƒ¨ç½²

### å¦‚æœäº‹ä»¶è¢«è§¦å‘ä½†ç‚¹æ•°æ²¡æœ‰å¢åŠ 

1. **æŸ¥çœ‹å‡½æ•°æ—¥å¿—**ï¼š
   - æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
   - æ£€æŸ¥äº‹ä»¶æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®

2. **æ£€æŸ¥äº‹ä»¶ç±»å‹è¯†åˆ«**ï¼š
   - æŸ¥çœ‹æ—¥å¿—ä¸­çš„ `eventType` å’Œ `productId`
   - ç¡®è®¤äº‹ä»¶ç±»å‹æ˜¯å¦åŒ¹é…éè®¢é˜…è´­ä¹°çš„åˆ¤æ–­æ¡ä»¶

3. **æ‰‹åŠ¨æµ‹è¯•**ï¼š
   - å¯ä»¥ç›´æ¥åœ¨ Firestore ä¸­åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡æ¡£
   - æˆ–è€…è°ƒç”¨ `addPaidCredit` å‡½æ•°æµ‹è¯•

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆç›‘å¬å™¨æ²¡æœ‰è§¦å‘ï¼Ÿ

A: å¯èƒ½çš„åŸå› ï¼š
1. Extension æ²¡æœ‰æ­£ç¡®å®‰è£…æˆ–é…ç½®
2. RevenueCat webhook æ²¡æœ‰æ­£ç¡®é…ç½®åˆ° Extension
3. Firestore é›†åˆè·¯å¾„ä¸åŒ¹é…
4. å‡½æ•°æœªéƒ¨ç½²

### Q: å¦‚ä½•ç¡®è®¤ Extension æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ

A: 
1. æ£€æŸ¥ Firestore ä¸­æ˜¯å¦æœ‰ `payments/rc` é›†åˆ
2. æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„è´­ä¹°äº‹ä»¶æ–‡æ¡£è¢«åˆ›å»º
3. æŸ¥çœ‹ Extension çš„æ‰§è¡Œæ—¥å¿—

### Q: äº‹ä»¶æ•°æ®æ ¼å¼æ˜¯ä»€ä¹ˆï¼Ÿ

A: RevenueCat Firebase Extension å†™å…¥çš„æ•°æ®æ ¼å¼å¯èƒ½å› ç‰ˆæœ¬è€Œå¼‚ã€‚å½“å‰ä»£ç æ”¯æŒå¤šç§å­—æ®µåæ ¼å¼ï¼Œå¹¶ä¼šè®°å½•å®Œæ•´çš„äº‹ä»¶æ•°æ®åˆ°æ—¥å¿—ä¸­ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚

## éƒ¨ç½²æ­¥éª¤

1. éƒ¨ç½² Functionsï¼š
   ```bash
   cd functions
   npm run build
   firebase deploy --only functions
   ```

2. éƒ¨ç½² Firestore è§„åˆ™ï¼š
   ```bash
   firebase deploy --only firestore:rules
   ```

3. éªŒè¯éƒ¨ç½²ï¼š
   ```bash
   firebase functions:list
   ```
